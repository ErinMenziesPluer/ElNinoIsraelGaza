# Function to Look for Coldsnaps in ERA5 Temp Data
#Dataframe has columns x, y, days,and the variable for analysis
#Temp_threshold is the temperature that indicates a coldsnap
#Day_Threshold is how many days in a row at the Temp_threshold indicates a coldsnap
#Variable is the number of the column in the Dataframe that you want to analyze, ie. MaxTemp or MeanTemp

#Before you run the function you need to set your working directory 
# and read in your dataframe

Coldsnaps<-function(Dataframe,Temp_threshold,Day_Threshold,Variable){
  Dataframe$days=as.numeric(Dataframe$days)
  Dataframe$binary=0
  Dataframe$binary[which(Dataframe[,Variable]<=Temp_threshold)]=1
  
  Coldsnap=data.frame(x=NA,y=NA,days=NA,streak=NA)
  Coldsnap=Coldsnap[-1,]
  
  yesterday=Dataframe[which(Dataframe$days==1),c("x","y")]
  yesterday$yest_binary=0
  
  for (i in 1:length(unique(Dataframe$days))){
    today=Dataframe[which(Dataframe$days==i),c("x","y","days","binary")]
    combine=merge(today,yesterday,all=T)
    combine$streak=combine$yest_binary/combine$binary
    combine$streak=combine$streak+1
    combine$streak[is.nan(combine$streak)]=0
    combine$streak[is.infinite(combine$streak)]=0
    Coldsnap=rbind(Coldsnap,combine[which(combine$streak>=Day_Threshold),c("x","y","days","streak")])
    yesterday=combine[,c("x","y","streak")]
    yesterday$yest_binary=yesterday$streak
  }
  
  #now pull out the total number of days each location was in a coldsnap
  Summary=Coldsnap[,c(1,2)]
  Summary=Summary[!duplicated(t(apply(Summary,1,sort))),]
  Summary$ColdsnapDays=0
  
  for (i in 1:length(Summary$x)){
    Grab=Coldsnap[which(Coldsnap$x==Summary$x[i]&Coldsnap$y==Summary$y[i]),]
    for(j in 1:length(Grab$x)){
      if(Grab$streak[j]==Day_Threshold){
        Summary$ColdsnapDays[i]=Summary$ColdsnapDays[i]+Day_Threshold
      }else{
        Summary$ColdsnapDays[i]=Summary$ColdsnapDays[i]+1
      }
    }
  }
  return(Summary)
}
